# Nginx configuration for Adventy application
# This configuration proxies requests to the .NET backend running on localhost:5000
# and serves static files from the React frontend build
#
# Features:
# - Accepts HTTP requests on port 80
# - Accepts HTTPS requests on port 443 (configure SSL certificates)
# - Accepts requests by domain name OR IP address
# - Proxies /api requests to .NET backend
# - Serves React frontend static files
#
# Installation:
# 1. Copy this file to /etc/nginx/sites-available/adventy
# 2. Edit the file and update:
#    - server_name: Currently configured for '2966415-bp32333.twc1.net' (or leave _ for IP access)
#    - ssl_certificate paths (for HTTPS) - see deployment/SSL_CERTIFICATES.md
#    - root path if deployment path is different from /opt/adventy/wwwroot
# 3. Create symlink: sudo ln -s /etc/nginx/sites-available/adventy /etc/nginx/sites-enabled/
# 4. Remove default site if needed: sudo rm /etc/nginx/sites-enabled/default
# 5. Test configuration: sudo nginx -t
# 6. Reload nginx: sudo systemctl reload nginx
#
# Note: The server_name includes '_' which allows requests by IP address.
# For HTTPS, you need to configure SSL certificates (see README.md)

# Rate limiting zone (optional, uncomment if needed)
# limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

# Upstream backend server
upstream adventy_backend {
    server localhost:5000;
    # Increased keepalive connections for high load
    keepalive 512;
    keepalive_requests 10000;
    keepalive_timeout 75s;
}

# HTTP server - accepts requests by domain name or IP address
server {
    listen 80;
    # Accept requests by domain name, IP address, or any hostname
    # The server will also accept requests by IP address
    server_name 2966415-bp32333.twc1.net _;

    # Redirect HTTP to HTTPS (uncomment when SSL is configured)
    # return 301 https://$host$request_uri;

    # Logging
    access_log /var/log/nginx/adventy_access.log;
    error_log /var/log/nginx/adventy_error.log;

    # Maximum upload size
    client_max_body_size 10M;
    
    # Connection limits - increased for high load
    # Maximum number of simultaneous connections per worker
    # This should match or exceed worker_connections in main nginx.conf
    # Default is usually 1024, but we allow more
    # Note: Actual limit is set in /etc/nginx/nginx.conf worker_connections
    
    # Buffer sizes for high load
    client_body_buffer_size 128k;
    client_header_buffer_size 4k;
    large_client_header_buffers 4 32k;
    
    # Connection timeouts - increased for high load
    client_body_timeout 120s;
    client_header_timeout 120s;
    send_timeout 120s;

    # Serve static files from React build
    root /opt/adventy/wwwroot;
    index index.html;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;

    # Cache static assets
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # Proxy API requests to .NET backend
    location /api {
        # Rate limiting (optional, uncomment if needed)
        # limit_req zone=api_limit burst=20 nodelay;

        proxy_pass http://adventy_backend;
        proxy_http_version 1.1;

        # Headers
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection keep-alive;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # Preserve custom headers needed by the API
        proxy_set_header X-Timezone $http_x_timezone;

        # Timeouts - increased for high load
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        
        # Buffer settings for high load
        proxy_buffer_size 16k;
        proxy_buffers 8 16k;
        proxy_busy_buffers_size 32k;
        
        # Connection pooling
        proxy_set_header Connection "";

        # Disable buffering for streaming responses
        proxy_buffering off;
        proxy_cache_bypass $http_upgrade;
    }

    # Serve React app (SPA fallback)
    location / {
        try_files $uri $uri/ /index.html;

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
    }

    # Health check endpoint (if you add one to your API)
    location /health {
        proxy_pass http://adventy_backend;
        access_log off;
    }

    # Deny access to hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# HTTPS server - accepts requests by domain name or IP address
# Uncomment and configure when SSL certificate is available
# To enable HTTPS:
# 1. Uncomment the server block below
# 2. Configure ssl_certificate and ssl_certificate_key paths
# 3. Test: sudo nginx -t
# 4. Reload: sudo systemctl reload nginx
#
#server {
#    listen 443 ssl http2;
#    # Accept requests by domain name, IP address, or any hostname
#    # The server will also accept requests by IP address
#    server_name 2966415-bp32333.twc1.net _;

    # SSL certificate paths (update with your certificate paths)
    # For Let's Encrypt:
    # ssl_certificate /etc/letsencrypt/live/2966415-bp32333.twc1.net/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/2966415-bp32333.twc1.net/privkey.pem;
    #
    # For self-signed certificate (development/testing only):
    # ssl_certificate /etc/nginx/ssl/cert.pem;
    # ssl_certificate_key /etc/nginx/ssl/key.pem;
    #
    # IMPORTANT: Uncomment the ssl_certificate lines above when enabling HTTPS

    # SSL configuration
#    ssl_protocols TLSv1.2 TLSv1.3;
#    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
#    ssl_prefer_server_ciphers off;
#    ssl_session_cache shared:SSL:10m;
#    ssl_session_timeout 10m;
#    ssl_session_tickets off;
#
#    # Security headers
#    add_header Strict-Transport-Security "max-age=63072000" always;

#    # Logging
#    access_log /var/log/nginx/adventy_ssl_access.log;
#    error_log /var/log/nginx/adventy_ssl_error.log;
#
#    # Maximum upload size
#    client_max_body_size 10M;
#    
#    # Connection limits - increased for high load
#    # Buffer sizes for high load
#    client_body_buffer_size 128k;
#    client_header_buffer_size 4k;
#    large_client_header_buffers 4 32k;
#    
#    # Connection timeouts - increased for high load
#    client_body_timeout 120s;
#    client_header_timeout 120s;
#    send_timeout 120s;
#
#    # Serve static files from React build
#    root /opt/adventy/wwwroot;
#    index index.html;
#
#    # Gzip compression
#    gzip on;
#    gzip_vary on;
#    gzip_min_length 1024;
#    gzip_proxied any;
#    gzip_comp_level 6;
#    gzip_types
#        text/plain
#        text/css
#        text/xml
#        text/javascript
#        application/json
#        application/javascript
#        application/xml+rss
#        application/atom+xml
#        image/svg+xml;
#
#    # Cache static assets
#    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp)$ {
#        expires 1y;
#        add_header Cache-Control "public, immutable";
#        access_log off;
#    }
#
#    # Proxy API requests to .NET backend
#    location /api {
#        # Rate limiting (optional, uncomment if needed)
#        # limit_req zone=api_limit burst=20 nodelay;
#
#        proxy_pass http://adventy_backend;
#        proxy_http_version 1.1;
#
#        # Headers
#        proxy_set_header Upgrade $http_upgrade;
#        proxy_set_header Connection keep-alive;
#        proxy_set_header Host $host;
#        proxy_set_header X-Real-IP $remote_addr;
#        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#        proxy_set_header X-Forwarded-Proto $scheme;
#        proxy_set_header X-Forwarded-Host $host;
#        proxy_set_header X-Forwarded-Port $server_port;
#
#        # Preserve custom headers needed by the API
#        proxy_set_header X-Timezone $http_x_timezone;
#
#        # Timeouts - increased for high load
#        proxy_connect_timeout 300s;
#        proxy_send_timeout 300s;
#        proxy_read_timeout 300s;
#        
#        # Buffer settings for high load
#        proxy_buffer_size 16k;
#        proxy_buffers 8 16k;
#        proxy_busy_buffers_size 32k;
#        
#        # Connection pooling
#        proxy_set_header Connection "";
#
#        # Disable buffering for streaming responses
#        proxy_buffering off;
#        proxy_cache_bypass $http_upgrade;
#    }
#
#    # Serve React app (SPA fallback)
#    location / {
#        try_files $uri $uri/ /index.html;
#
#        # Security headers
#        add_header X-Frame-Options "SAMEORIGIN" always;
#        add_header X-Content-Type-Options "nosniff" always;
#        add_header X-XSS-Protection "1; mode=block" always;
#    }
#
#    # Health check endpoint (if you add one to your API)
#    location /health {
#        proxy_pass http://adventy_backend;
#        access_log off;
#    }
#
#    # Deny access to hidden files
#    location ~ /\. {
#        deny all;
#        access_log off;
#        log_not_found off;
#    }
#}

